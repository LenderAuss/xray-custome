#!/bin/bash
apt update
apt install qrencode curl jq -y

# Включаем bbr
bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control)
if [ "$bbr" = "net.ipv4.tcp_congestion_control = bbr" ]; then
    echo "bbr уже включен"
else
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    echo "bbr включен"
fi

# Устанавливаем ядро Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# Генерируем ОБЩИЕ ключи
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

# ✅ ПРАВИЛЬНЫЙ парсинг: xray x25519 выводит "Private key <ключ>" БЕЗ двоеточия
export uuid=$(awk -F': ' '/uuid/ {print $2}' /usr/local/etc/xray/.keys)
export privatkey=$(awk '/Private key/ {print $3}' /usr/local/etc/xray/.keys)
export publickey=$(awk '/Public key/ {print $3}' /usr/local/etc/xray/.keys)
export shortsid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)

# Создаем файл конфигурации Xray с первым inbound для main
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning"
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "tag": "main",
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "$uuid",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "ozon.ru:443",
                    "xver": 0,
                    "serverNames": [
                        "ozon.ru",
                        "www.ozon.ru"
                    ],
                    "privateKey": "$privatkey",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$shortsid"
                    ]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 3,
                "connIdle": 180
            }
        }
    }
}
EOF

# Функция для получения свободного порта
cat << 'SCRIPT' > /usr/local/bin/get_free_port
#!/bin/bash
start_port=10000
end_port=65000

for ((port=start_port; port<=end_port; port++)); do
    if ! ss -tuln | grep -q ":$port "; then
        if ! jq -e ".inbounds[] | select(.port == $port)" /usr/local/etc/xray/config.json > /dev/null 2>&1; then
            echo $port
            exit 0
        fi
    fi
done

echo "0"
exit 1
SCRIPT
chmod +x /usr/local/bin/get_free_port

# Исполняемый файл для списка клиентов
cat << 'SCRIPT' > /usr/local/bin/userlist
#!/bin/bash
tags=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#tags[@]} -eq 0 ]]; then
    echo "Список клиентов пуст"
    exit 1
fi

echo "Список клиентов:"
for i in "${!tags[@]}"; do
    tag="${tags[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $tag (порт: $port)"
done
SCRIPT
chmod +x /usr/local/bin/userlist

# Исполняемый файл для ссылки основного пользователя
cat << 'SCRIPT' > /usr/local/bin/mainuser
#!/bin/bash
protocol=$(jq -r '.inbounds[0].protocol' /usr/local/etc/xray/config.json)
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
# ✅ ПРАВИЛЬНЫЙ парсинг: "Public key <ключ>" БЕЗ двоеточия
pbk=$(awk '/Public key/ {print $3}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#main"
echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/mainuser

# Исполняемый файл для создания новых клиентов
cat << 'SCRIPT' > /usr/local/bin/newuser
#!/bin/bash
read -p "Введите имя пользователя: " username

if [[ -z "$username" || "$username" == *" "* ]]; then
    echo "Имя пользователя не может быть пустым или содержать пробелы. Попробуйте снова."
    exit 1
fi

# Проверяем существование пользователя
existing_tag=$(jq -r --arg tag "$username" '.inbounds[] | select(.tag == $tag) | .tag' /usr/local/etc/xray/config.json)
if [[ -n "$existing_tag" ]]; then
    echo "Пользователь с таким именем уже существует. Попробуйте снова."
    exit 1
fi

# Получаем свободный порт
port=$(get_free_port)
if [[ "$port" == "0" ]]; then
    echo "Не удалось найти свободный порт"
    exit 1
fi

# Генерируем новый UUID
uuid=$(xray uuid)

# ✅ ПРАВИЛЬНЫЙ парсинг: получаем ОБЩИЕ ключи Reality
privatkey=$(awk '/Private key/ {print $3}' /usr/local/etc/xray/.keys)
pbk=$(awk '/Public key/ {print $3}' /usr/local/etc/xray/.keys)
shortsid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)

# Создаем новый inbound
new_inbound=$(cat <<EOF
{
    "tag": "$username",
    "listen": "0.0.0.0",
    "port": $port,
    "protocol": "vless",
    "settings": {
        "clients": [
            {
                "id": "$uuid",
                "flow": "xtls-rprx-vision"
            }
        ],
        "decryption": "none"
    },
    "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
            "show": false,
            "dest": "ozon.ru:443",
            "xver": 0,
            "serverNames": [
                "ozon.ru",
                "www.ozon.ru"
            ],
            "privateKey": "$privatkey",
            "minClientVer": "",
            "maxClientVer": "",
            "maxTimeDiff": 0,
            "shortIds": [
                "$shortsid"
            ]
        }
    },
    "sniffing": {
        "enabled": true,
        "destOverride": [
            "http",
            "tls"
        ]
    }
}
EOF
)

# Добавляем новый inbound в конфиг
jq --argjson new_inbound "$new_inbound" '.inbounds += [$new_inbound]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json

systemctl restart xray

# Генерируем ссылку
protocol="vless"
sni="ozon.ru"
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$shortsid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$username"

echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/newuser

# Исполняемый файл для удаления клиентов
cat << 'SCRIPT' > /usr/local/bin/rmuser
#!/bin/bash
tags=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#tags[@]} -eq 0 ]]; then
    echo "Нет клиентов для удаления."
    exit 1
fi

echo "Список клиентов:"
for i in "${!tags[@]}"; do
    tag="${tags[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $tag (порт: $port)"
done

read -p "Введите номер клиента для удаления: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#tags[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#tags[@]}"
    exit 1
fi

selected_tag="${tags[$((choice - 1))]}"

if [[ "$selected_tag" == "main" ]]; then
    echo "Нельзя удалить главного пользователя!"
    exit 1
fi

# Удаляем inbound
jq --arg tag "$selected_tag" 'del(.inbounds[] | select(.tag == $tag))' /usr/local/etc/xray/config.json > tmp && mv tmp /usr/local/etc/xray/config.json

systemctl restart xray

echo "Клиент $selected_tag удалён."
SCRIPT
chmod +x /usr/local/bin/rmuser

# Исполняемый файл для вывода списка пользователей и создания ссылок
cat << 'SCRIPT' > /usr/local/bin/sharelink
#!/bin/bash
tags=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#tags[@]} -eq 0 ]]; then
    echo "Список клиентов пуст"
    exit 1
fi

echo "Список клиентов:"
for i in "${!tags[@]}"; do
    tag="${tags[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $tag (порт: $port)"
done

read -p "Выберите клиента: " client

if ! [[ "$client" =~ ^[0-9]+$ ]] || (( client < 1 || client > ${#tags[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#tags[@]}"
    exit 1
fi

selected_index=$((client - 1))
selected_tag="${tags[$selected_index]}"

protocol=$(jq -r ".inbounds[$selected_index].protocol" /usr/local/etc/xray/config.json)
port=$(jq -r ".inbounds[$selected_index].port" /usr/local/etc/xray/config.json)
uuid=$(jq -r ".inbounds[$selected_index].settings.clients[0].id" /usr/local/etc/xray/config.json)
# ✅ ПРАВИЛЬНЫЙ парсинг: "Public key <ключ>" БЕЗ двоеточия
pbk=$(awk '/Public key/ {print $3}' /usr/local/etc/xray/.keys)
sid=$(awk -F': ' '/shortsid/ {print $2}' /usr/local/etc/xray/.keys)
sni=$(jq -r ".inbounds[$selected_index].streamSettings.realitySettings.serverNames[0]" /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)
link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$selected_tag"
echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/sharelink

systemctl restart xray

echo "Xray-core успешно установлен"
mainuser

# Создаем файл с подсказками
cat << 'EOF' > $HOME/help

Команды для управления пользователями Xray:

    mainuser - выводит ссылку для подключения основного пользователя
    newuser - создает нового пользователя на отдельном порту
    rmuser - удаление пользователей
    sharelink - выводит список пользователей и позволяет создать для них ссылки для подключения
    userlist - выводит список клиентов с портами

Особенности:
    • Каждый пользователь на отдельном порту (main на 443, остальные 10000-65000)
    • Общие ключи Reality для всех (безопасно!)
    • Уникальный UUID для каждого
    • Легко отслеживать трафик по портам

Файл конфигурации:
    /usr/local/etc/xray/config.json

Ключи Reality:
    /usr/local/etc/xray/.keys

Команды:
    systemctl restart xray          # перезагрузка
    systemctl status xray           # статус
    journalctl -u xray -f           # логи в реальном времени

Мониторинг трафика:
    ss -tn | grep :10001            # соединения конкретного порта
    netstat -an | grep :10001       # альтернатива
    iftop -i eth0 -f "port 10001"   # детальный мониторинг

Проверка ключей:
    cat /usr/local/etc/xray/.keys   # просмотр всех ключей

EOF

echo ""
echo "Справка сохранена в ~/help"
echo ""
