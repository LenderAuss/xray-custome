#!/bin/bash

apt update
apt install qrencode curl jq -y

# Включаем bbr
bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control)
if [ "$bbr" = "net.ipv4.tcp_congestion_control = bbr" ]; then
    echo "bbr уже включен"
else
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    echo "bbr включен"
fi

# Устанавливаем ядро Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# Генерируем ОБЩИЕ ключи один раз (как в оригинале)
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

export uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
export privatkey=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
export shortsid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# Создаем файл для хранения портов пользователей
touch /usr/local/etc/xray/.ports
echo "main:443" >> /usr/local/etc/xray/.ports

# Создаем начальную конфигурацию с одним главным inbound
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning"
    },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            {
                "type": "field",
                "domain": [
                    "geosite:category-ads-all"
                ],
                "outboundTag": "block"
            }
        ]
    },
    "inbounds": [
        {
            "tag": "main",
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "$uuid",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "ozon.ru:443",
                    "xver": 0,
                    "serverNames": [
                        "ozon.ru",
                        "www.ozon.ru"
                    ],
                    "privateKey": "$privatkey",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$shortsid"
                    ]
                }
            },
            "sniffing": {
                "enabled": true,
                "destOverride": [
                    "http",
                    "tls"
                ]
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        },
        {
            "protocol": "blackhole",
            "tag": "block"
        }
    ],
    "policy": {
        "levels": {
            "0": {
                "handshake": 3,
                "connIdle": 180
            }
        }
    }
}
EOF

# Функция для получения свободного порта
cat << 'SCRIPT' > /usr/local/bin/get_free_port
#!/bin/bash
start_port=10000
end_port=65000

for ((port=start_port; port<=end_port; port++)); do
    if ! ss -tuln | grep -q ":$port "; then
        # Проверяем, не используется ли порт в конфиге
        if ! jq -e ".inbounds[] | select(.port == $port)" /usr/local/etc/xray/config.json > /dev/null 2>&1; then
            echo $port
            exit 0
        fi
    fi
done

echo "0"
exit 1
SCRIPT
chmod +x /usr/local/bin/get_free_port

# Команда для списка пользователей
cat << 'SCRIPT' > /usr/local/bin/userlist
#!/bin/bash
users=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#users[@]} -eq 0 ]]; then
    echo "Список пользователей пуст"
    exit 1
fi

echo "Список пользователей:"
for i in "${!users[@]}"; do
    username="${users[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $username (порт: $port)"
done
SCRIPT
chmod +x /usr/local/bin/userlist

# Команда для получения ссылки главного пользователя
cat << 'SCRIPT' > /usr/local/bin/mainuser
#!/bin/bash
protocol="vless"
port=$(jq -r '.inbounds[0].port' /usr/local/etc/xray/config.json)
uuid=$(jq -r '.inbounds[0].settings.clients[0].id' /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
sni=$(jq -r '.inbounds[0].streamSettings.realitySettings.serverNames[0]' /usr/local/etc/xray/config.json)
ip=$(timeout 3 curl -4 -s icanhazip.com)

link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#main"

echo ""
echo "Ссылка для подключения (main):"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/mainuser

# Команда для создания нового пользователя
cat << 'SCRIPT' > /usr/local/bin/newuser
#!/bin/bash

read -p "Введите имя пользователя: " username

if [[ -z "$username" || "$username" == *" "* ]]; then
    echo "Имя пользователя не может быть пустым или содержать пробелы"
    exit 1
fi

# Проверяем, существует ли уже такой пользователь
existing_tag=$(jq -r --arg tag "$username" '.inbounds[] | select(.tag == $tag) | .tag' /usr/local/etc/xray/config.json)
if [[ -n "$existing_tag" ]]; then
    echo "Пользователь $username уже существует"
    exit 1
fi

# Получаем свободный порт
port=$(get_free_port)
if [[ "$port" == "0" ]]; then
    echo "Не удалось найти свободный порт"
    exit 1
fi

# Генерируем UUID для нового пользователя
new_uuid=$(xray uuid)

# Получаем ОБЩИЕ ключи (как в оригинале)
privatkey=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey/ {print $2}')
shortsid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# Добавляем новый inbound в конфиг (используем ОБЩИЕ ключи Reality)
new_inbound=$(cat <<EOF
{
    "tag": "$username",
    "listen": "0.0.0.0",
    "port": $port,
    "protocol": "vless",
    "settings": {
        "clients": [
            {
                "id": "$new_uuid",
                "flow": "xtls-rprx-vision"
            }
        ],
        "decryption": "none"
    },
    "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
            "show": false,
            "dest": "ozon.ru:443",
            "xver": 0,
            "serverNames": [
                "ozon.ru",
                "www.ozon.ru"
            ],
            "privateKey": "$privatkey",
            "minClientVer": "",
            "maxClientVer": "",
            "maxTimeDiff": 0,
            "shortIds": [
                "$shortsid"
            ]
        }
    },
    "sniffing": {
        "enabled": true,
        "destOverride": [
            "http",
            "tls"
        ]
    }
}
EOF
)

# Добавляем inbound в конфиг
jq --argjson new_inbound "$new_inbound" '.inbounds += [$new_inbound]' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json

# Сохраняем порт пользователя
echo "$username:$port" >> /usr/local/etc/xray/.ports

systemctl restart xray

sni="ozon.ru"
ip=$(curl -4 -s icanhazip.com)
link="vless://$new_uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$shortsid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$username"

echo ""
echo "Пользователь $username создан на порту $port"
echo ""
echo "Ссылка для подключения:"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/newuser

# Команда для удаления пользователя
cat << 'SCRIPT' > /usr/local/bin/rmuser
#!/bin/bash

users=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#users[@]} -eq 0 ]]; then
    echo "Нет пользователей для удаления"
    exit 1
fi

echo "Список пользователей:"
for i in "${!users[@]}"; do
    username="${users[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $username (порт: $port)"
done

read -p "Введите номер пользователя для удаления: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#users[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#users[@]}"
    exit 1
fi

selected_user="${users[$((choice - 1))]}"

if [[ "$selected_user" == "main" ]]; then
    echo "Нельзя удалить главного пользователя!"
    exit 1
fi

# Удаляем inbound из конфига
jq --arg tag "$selected_user" 'del(.inbounds[] | select(.tag == $tag))' /usr/local/etc/xray/config.json > tmp.json && mv tmp.json /usr/local/etc/xray/config.json

# Удаляем порт из списка
sed -i "/^$selected_user:/d" /usr/local/etc/xray/.ports

systemctl restart xray

echo "Пользователь $selected_user удалён"
SCRIPT
chmod +x /usr/local/bin/rmuser

# Команда для получения ссылки пользователя
cat << 'SCRIPT' > /usr/local/bin/sharelink
#!/bin/bash

users=($(jq -r '.inbounds[].tag' /usr/local/etc/xray/config.json))

if [[ ${#users[@]} -eq 0 ]]; then
    echo "Список пользователей пуст"
    exit 1
fi

echo "Список пользователей:"
for i in "${!users[@]}"; do
    username="${users[$i]}"
    port=$(jq -r ".inbounds[$i].port" /usr/local/etc/xray/config.json)
    echo "$((i+1)). $username (порт: $port)"
done

read -p "Выберите пользователя: " choice

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#users[@]} )); then
    echo "Ошибка: номер должен быть от 1 до ${#users[@]}"
    exit 1
fi

selected_index=$((choice - 1))
selected_user="${users[$selected_index]}"

protocol="vless"
port=$(jq -r ".inbounds[$selected_index].port" /usr/local/etc/xray/config.json)
uuid=$(jq -r ".inbounds[$selected_index].settings.clients[0].id" /usr/local/etc/xray/config.json)
pbk=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PublicKey/ {print $2}')
sid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')
sni=$(jq -r ".inbounds[$selected_index].streamSettings.realitySettings.serverNames[0]" /usr/local/etc/xray/config.json)
ip=$(curl -4 -s icanhazip.com)

link="$protocol://$uuid@$ip:$port?security=reality&sni=$sni&fp=firefox&pbk=$pbk&sid=$sid&spx=/&type=tcp&flow=xtls-rprx-vision&encryption=none#$selected_user"

echo ""
echo "Ссылка для подключения ($selected_user):"
echo "$link"
echo ""
echo "QR-код:"
echo ${link} | qrencode -t ansiutf8
SCRIPT
chmod +x /usr/local/bin/sharelink

systemctl restart xray

echo ""
echo "============================================="
echo "Xray-core успешно установлен!"
echo "============================================="
echo ""
mainuser

# Создаем файл с подсказками
cat << 'EOF' > $HOME/help

Команды для управления пользователями Xray:

    mainuser   - показать ссылку главного пользователя
    newuser    - создать нового пользователя на новом порту
    rmuser     - удалить пользователя
    sharelink  - получить ссылку для любого пользователя
    userlist   - показать список всех пользователей

Особенности:
    • Каждый пользователь получает свой отдельный inbound на уникальном порту
    • Порты назначаются автоматически из диапазона 10000-65000
    • ВСЕ пользователи используют ОБЩИЕ ключи Reality (privateKey, publicKey, shortId)
    • Каждый пользователь имеет свой уникальный UUID
    • Главный пользователь "main" нельзя удалить

Файлы:
    Конфигурация:    /usr/local/etc/xray/config.json
    Общие ключи:     /usr/local/etc/xray/.keys
    Список портов:   /usr/local/etc/xray/.ports

Команды Xray:
    systemctl restart xray  - перезапустить
    systemctl status xray   - проверить статус
    systemctl stop xray     - остановить

EOF

echo ""
echo "Справка сохранена в ~/help"
echo "Используйте команду: cat ~/help"
echo ""
